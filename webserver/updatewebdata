#!/bin/bash
# Get yesterday's RBN data and run a full analysis on it
cd /home/pi/rbnskew/webserver
FILE=`date --date="1 days ago" +%Y%m%d`
echo "---"
echo "Job started "`date -u "+%F %T" `
echo "Downloading RBN data for "`date -u --date="1 days ago" +%Y-%m-%d`
wget --quiet --no-hsts http://www.reversebeacon.net/raw_data/dl.php?f=$FILE -O rbndata.zip
FILESIZE=$(stat -c%s rbndata.zip)
if [[ $FILESIZE != "0" ]]; then
    gunzip < rbndata.zip > rbndata.csv
    echo "Downloaded yesterday's "$((`wc -l < rbndata.csv` - 2))" spots into rbndata.csv"
    echo "To improve the accuracy of your skimmer, multiply the current value of" > temp.txt
    echo "FreqCalibration in SkimSrv.ini with the adjustment factor below." >> temp.txt
    echo >> temp.txt
    cd ..
    ./rbnskew -q -f webserver/rbndata.csv | sed "/processing/c\ " >> webserver/temp.txt
    cd webserver
    echo >> temp.txt
    echo "Page last updated "`date -u` >> temp.txt
    cp temp.txt rbnskew.txt
    echo "Updated web data in rbnskew.txt"
#
    echo "To improve the accuracy of your skimmer, multiply the current value of" > temp2.txt
    echo "FreqCalibration in SkimSrv.ini with the adjustment factor below." >> temp2.txt
    echo >> temp2.txt
    cd ..
    ./rbnskew -q -s -w -f webserver/rbndata.csv | sed "/processing/c\ " >> webserver/temp2.txt
    cd webserver
    echo >> temp2.txt
    echo "Page last updated "`date -u` >> temp2.txt
    cp temp2.txt rbnskew2.txt
    echo "Updated web data in rbnskew2.txt"
    ./upload
    echo "Uploaded to web hosting"
else
    echo "Could not download yesterday's RBN data!"
fi
exit
